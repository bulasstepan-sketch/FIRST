<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Трекер тренировок Valorant</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-slate-950 text-slate-100">
    <main class="mx-auto flex w-full max-w-6xl flex-col gap-6 px-4 py-10 md:flex-row">
      <section class="w-full md:w-5/12">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-5 shadow-xl">
          <div class="mb-4 flex items-center justify-between">
            <div class="flex flex-col gap-3">
              <div class="flex flex-wrap gap-3 text-xs uppercase tracking-widest text-slate-400">
                <label class="flex flex-col gap-1">
                  <span>Год</span>
                  <select
                    id="yearSelect"
                    class="rounded-lg border border-slate-800 bg-slate-950/60 px-2 py-1 text-sm text-slate-100 focus:border-red-500 focus:outline-none"
                  ></select>
                </label>
                <label class="flex flex-col gap-1">
                  <span>Месяц</span>
                  <select
                    id="monthSelect"
                    class="rounded-lg border border-slate-800 bg-slate-950/60 px-2 py-1 text-sm text-slate-100 focus:border-red-500 focus:outline-none"
                  ></select>
                </label>
              </div>
              <div>
                <p class="text-sm uppercase tracking-widest text-slate-400">Календарь</p>
                <h1 id="monthLabel" class="text-2xl font-semibold text-slate-100"></h1>
              </div>
            </div>
            <div class="rounded-full border border-red-500/30 bg-red-500/10 px-3 py-1 text-xs font-semibold uppercase tracking-wider text-red-300">
              Фокус Valorant
            </div>
          </div>
          <div class="grid grid-cols-7 gap-2 text-center text-xs uppercase tracking-widest text-slate-500">
            <span>ПН</span>
            <span>ВТ</span>
            <span>СР</span>
            <span>ЧТ</span>
            <span>ПТ</span>
            <span>СБ</span>
            <span>ВС</span>
          </div>
          <div id="calendarGrid" class="mt-3 grid grid-cols-7 gap-2"></div>
        </div>
      </section>

      <section class="flex w-full flex-col gap-6 md:w-7/12">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-6 shadow-xl">
          <div class="mb-4 flex items-center justify-between">
            <div>
              <p class="text-sm uppercase tracking-widest text-slate-400">Тренировка за день</p>
              <h2 id="selectedDateLabel" class="text-xl font-semibold"></h2>
            </div>
            <span class="text-xs uppercase tracking-widest text-red-300">Трекер</span>
          </div>
          <div>
            <h3 class="mb-3 text-sm uppercase tracking-widest text-slate-400">План тренировки</h3>
            <ul id="planList" class="space-y-3"></ul>
          </div>
          <div class="mt-6">
            <label for="dailyNote" class="text-sm uppercase tracking-widest text-slate-400">Заметка за день</label>
            <textarea
              id="dailyNote"
              rows="4"
              class="mt-2 w-full rounded-lg border border-slate-800 bg-slate-950/60 p-3 text-sm text-slate-100 focus:border-red-500 focus:outline-none"
              placeholder="Что получилось сегодня? Что нужно улучшить?"
            ></textarea>
          </div>
          <button
            id="saveDay"
            class="mt-4 w-full rounded-lg bg-red-500/90 px-4 py-2 text-sm font-semibold uppercase tracking-widest text-white hover:bg-red-400"
          >
            Сохранить
          </button>
        </div>

        <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-6 shadow-xl">
          <div class="mb-4 flex items-center justify-between">
            <div>
              <p class="text-sm uppercase tracking-widest text-slate-400">Редактор плана</p>
              <h3 class="text-lg font-semibold">Соберите свой план</h3>
            </div>
            <span class="text-xs uppercase tracking-widest text-red-300">Редактировать</span>
          </div>
          <form id="planForm" class="grid gap-4 md:grid-cols-3">
            <div class="md:col-span-1">
              <label class="text-xs uppercase tracking-widest text-slate-400">Название</label>
              <input
                id="blockTitle"
                class="mt-1 w-full rounded-lg border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm focus:border-red-500 focus:outline-none"
                placeholder="Тренировка аима"
                required
              />
            </div>
            <div class="md:col-span-1">
              <label class="text-xs uppercase tracking-widest text-slate-400">Описание</label>
              <input
                id="blockDescription"
                class="mt-1 w-full rounded-lg border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm focus:border-red-500 focus:outline-none"
                placeholder="Полигон + боты"
              />
            </div>
            <div class="md:col-span-1">
              <label class="text-xs uppercase tracking-widest text-slate-400">Длительность (мин)</label>
              <input
                id="blockDuration"
                type="number"
                min="0"
                class="mt-1 w-full rounded-lg border border-slate-800 bg-slate-950/60 px-3 py-2 text-sm focus:border-red-500 focus:outline-none"
                placeholder="20"
              />
            </div>
            <div class="md:col-span-3">
              <button
                class="w-full rounded-lg border border-red-500/50 bg-red-500/20 px-4 py-2 text-sm font-semibold uppercase tracking-widest text-red-200 hover:bg-red-500/30"
                type="submit"
              >
                Добавить упражнение
              </button>
            </div>
          </form>
          <p class="mt-4 text-xs text-slate-500">
            Совет: делайте упражнения короткими и сфокусированными для стабильности.
          </p>
        </div>
      </section>
    </main>

    <script>
      // Data models
      /** @typedef {{ id: string, title: string, description?: string, durationMinutes?: number }} TrainingBlock */
      /** @typedef {TrainingBlock[]} TrainingPlan */
      /** @typedef {{ date: string, completedBlockIds: string[], note: string }} DayEntry */

      const STORAGE_KEYS = {
        plan: "valorantTrainingPlan",
        entries: "valorantDayEntries",
      };

      const calendarGrid = document.getElementById("calendarGrid");
      const monthLabel = document.getElementById("monthLabel");
      const yearSelect = document.getElementById("yearSelect");
      const monthSelect = document.getElementById("monthSelect");
      const selectedDateLabel = document.getElementById("selectedDateLabel");
      const planList = document.getElementById("planList");
      const dailyNote = document.getElementById("dailyNote");
      const saveDay = document.getElementById("saveDay");
      const planForm = document.getElementById("planForm");
      const blockTitle = document.getElementById("blockTitle");
      const blockDescription = document.getElementById("blockDescription");
      const blockDuration = document.getElementById("blockDuration");

      let trainingPlan = loadTrainingPlan();
      let dayEntries = loadDayEntries();
      let selectedDate = getISODate(new Date());

      const MONTHS_RU = [
        "Январь",
        "Февраль",
        "Март",
        "Апрель",
        "Май",
        "Июнь",
        "Июль",
        "Август",
        "Сентябрь",
        "Октябрь",
        "Ноябрь",
        "Декабрь",
      ];

      const today = new Date();
      let currentYear = today.getFullYear();
      let currentMonth = today.getMonth();

      function getDayCompletionStatus(dateString) {
        if (trainingPlan.length === 0) {
          return "none";
        }

        const entry = dayEntries[dateString];
        if (!entry) {
          return "none";
        }

        const validBlockIds = new Set(trainingPlan.map((block) => block.id));
        const completedCount = entry.completedBlockIds.filter((id) => validBlockIds.has(id)).length;

        if (completedCount === 0) {
          return "none";
        }
        if (completedCount >= trainingPlan.length) {
          return "complete";
        }
        return "partial";
      }

      function applyCalendarStatus(button, status) {
        if (status === "complete") {
          button.classList.add("ring-1", "ring-inset", "ring-emerald-400/70");
        } else if (status === "partial") {
          button.classList.add("ring-1", "ring-inset", "ring-amber-300/70");
        }
      }

      // Calendar rendering logic for the selected month/year
      function renderCalendar() {
        calendarGrid.innerHTML = "";
        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        // Используем русскую локаль для отображения месяца и года.
        monthLabel.textContent = firstDay.toLocaleDateString("ru-RU", {
          month: "long",
          year: "numeric",
        });

        // Неделя начинается с понедельника.
        const firstDayOffset = (firstDay.getDay() + 6) % 7;
        for (let i = 0; i < firstDayOffset; i += 1) {
          const spacer = document.createElement("div");
          calendarGrid.appendChild(spacer);
        }

        for (let day = 1; day <= lastDay.getDate(); day += 1) {
          const date = new Date(currentYear, currentMonth, day);
          const dateString = getISODate(date);
          const button = document.createElement("button");
          const hasEntry = Boolean(dayEntries[dateString]);
          const completionStatus = getDayCompletionStatus(dateString);

          button.type = "button";
          button.textContent = day;
          button.dataset.date = dateString;
          button.className =
            "rounded-lg border border-slate-800 px-2 py-3 text-sm transition hover:border-red-500/60 hover:text-red-200";

          if (dateString === selectedDate) {
            button.classList.add("bg-red-500/30", "text-red-100", "border-red-500");
          } else if (hasEntry) {
            button.classList.add("bg-slate-800/70", "text-slate-200");
          } else {
            button.classList.add("bg-slate-950/40", "text-slate-400");
          }

          applyCalendarStatus(button, completionStatus);

          button.addEventListener("click", () => {
            selectedDate = dateString;
            renderCalendar();
            renderDayPanel();
          });

          calendarGrid.appendChild(button);
        }
      }

      // Render blocks and daily note for selected date
      function renderDayPanel() {
        selectedDateLabel.textContent = formatDisplayDate(selectedDate);
        const entry = getDayEntry(selectedDate);
        dailyNote.value = entry.note;

        planList.innerHTML = "";
        if (trainingPlan.length === 0) {
          const emptyState = document.createElement("p");
          emptyState.className = "text-sm text-slate-500";
          emptyState.textContent = "Пока нет упражнений. Добавьте первое упражнение ниже.";
          planList.appendChild(emptyState);
          return;
        }

        trainingPlan.forEach((block) => {
          const listItem = document.createElement("li");
          listItem.className = "flex items-start justify-between gap-4 rounded-xl border border-slate-800 bg-slate-950/60 p-3";

          const info = document.createElement("div");
          const title = document.createElement("p");
          title.className = "text-sm font-semibold text-slate-100";
          title.textContent = block.title;
          info.appendChild(title);

          if (block.description) {
            const description = document.createElement("p");
            description.className = "text-xs text-slate-400";
            description.textContent = block.description;
            info.appendChild(description);
          }

          if (block.durationMinutes) {
            const duration = document.createElement("p");
            duration.className = "text-xs text-slate-500";
            duration.textContent = `${block.durationMinutes} мин`;
            info.appendChild(duration);
          }

          const controls = document.createElement("div");
          controls.className = "flex flex-col items-end gap-2";

          const label = document.createElement("label");
          label.className = "flex items-center gap-2 text-xs uppercase tracking-widest text-slate-400";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.checked = entry.completedBlockIds.includes(block.id);
          checkbox.className = "h-4 w-4 rounded border-slate-700 bg-slate-950 text-red-500 focus:ring-red-500";
          checkbox.addEventListener("change", () => {
            toggleBlockCompletion(block.id, checkbox.checked);
          });

          const checkboxText = document.createElement("span");
          checkboxText.textContent = "Выполнено";

          label.appendChild(checkbox);
          label.appendChild(checkboxText);

          const deleteButton = document.createElement("button");
          deleteButton.type = "button";
          deleteButton.className = "text-xs uppercase tracking-widest text-red-300 hover:text-red-200";
          deleteButton.textContent = "Удалить";
          deleteButton.addEventListener("click", () => {
            deleteBlock(block.id);
          });

          controls.appendChild(label);
          controls.appendChild(deleteButton);

          listItem.appendChild(info);
          listItem.appendChild(controls);
          planList.appendChild(listItem);
        });
      }

      // Save logic for daily entry
      saveDay.addEventListener("click", () => {
        const entry = getDayEntry(selectedDate);
        entry.note = dailyNote.value.trim();
        dayEntries[selectedDate] = entry;
        persistDayEntries();
        renderCalendar();
      });

      // Add new training block
      planForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const title = blockTitle.value.trim();
        if (!title) {
          return;
        }

        const block = {
          id: crypto.randomUUID(),
          title,
          description: blockDescription.value.trim() || undefined,
          durationMinutes: blockDuration.value ? Number(blockDuration.value) : undefined,
        };

        trainingPlan.push(block);
        persistTrainingPlan();
        planForm.reset();
        renderDayPanel();
        renderCalendar();
      });

      function deleteBlock(blockId) {
        trainingPlan = trainingPlan.filter((block) => block.id !== blockId);
        Object.values(dayEntries).forEach((entry) => {
          entry.completedBlockIds = entry.completedBlockIds.filter((id) => id !== blockId);
        });
        persistTrainingPlan();
        persistDayEntries();
        renderDayPanel();
        renderCalendar();
      }

      function toggleBlockCompletion(blockId, isCompleted) {
        const entry = getDayEntry(selectedDate);
        if (isCompleted) {
          if (!entry.completedBlockIds.includes(blockId)) {
            entry.completedBlockIds.push(blockId);
          }
        } else {
          entry.completedBlockIds = entry.completedBlockIds.filter((id) => id !== blockId);
        }
        dayEntries[selectedDate] = entry;
        persistDayEntries();
        renderCalendar();
      }

      // Local storage helpers
      function loadTrainingPlan() {
        const stored = localStorage.getItem(STORAGE_KEYS.plan);
        if (!stored) {
          return [];
        }
        try {
          return JSON.parse(stored);
        } catch (error) {
          return [];
        }
      }

      function loadDayEntries() {
        const stored = localStorage.getItem(STORAGE_KEYS.entries);
        if (!stored) {
          return {};
        }
        try {
          const entries = JSON.parse(stored);
          return Array.isArray(entries)
            ? entries.reduce((acc, entry) => {
                acc[entry.date] = entry;
                return acc;
              }, {})
            : entries;
        } catch (error) {
          return {};
        }
      }

      function persistTrainingPlan() {
        localStorage.setItem(STORAGE_KEYS.plan, JSON.stringify(trainingPlan));
      }

      function persistDayEntries() {
        const entriesArray = Object.values(dayEntries);
        localStorage.setItem(STORAGE_KEYS.entries, JSON.stringify(entriesArray));
      }

      function getDayEntry(date) {
        return (
          dayEntries[date] || {
            date,
            completedBlockIds: [],
            note: "",
          }
        );
      }

      function getISODate(date) {
        return date.toISOString().split("T")[0];
      }

      function formatDisplayDate(dateString) {
        const date = new Date(`${dateString}T00:00:00`);
        // Русское форматирование даты для заголовка.
        return date.toLocaleDateString("ru-RU", {
          weekday: "long",
          month: "long",
          day: "numeric",
          year: "numeric",
        });
      }

      function populateSelectors() {
        // Заполняем список годов и месяцев для управления календарем.
        for (let year = 2020; year <= 2035; year += 1) {
          const option = document.createElement("option");
          option.value = String(year);
          option.textContent = year;
          yearSelect.appendChild(option);
        }

        MONTHS_RU.forEach((monthName, index) => {
          const option = document.createElement("option");
          option.value = String(index);
          option.textContent = monthName;
          monthSelect.appendChild(option);
        });

        yearSelect.value = String(currentYear);
        monthSelect.value = String(currentMonth);
      }

      function syncSelectedDate(year, month) {
        // Если выбранный день существует в новом месяце, сохраняем номер дня.
        const selectedDay = new Date(`${selectedDate}T00:00:00`).getDate();
        const lastDay = new Date(year, month + 1, 0).getDate();
        const nextDay = selectedDay <= lastDay ? selectedDay : 1;
        selectedDate = getISODate(new Date(year, month, nextDay));
      }

      function handleSelectorChange() {
        currentYear = Number(yearSelect.value);
        currentMonth = Number(monthSelect.value);
        syncSelectedDate(currentYear, currentMonth);
        renderCalendar();
        renderDayPanel();
      }

      yearSelect.addEventListener("change", handleSelectorChange);
      monthSelect.addEventListener("change", handleSelectorChange);

      populateSelectors();
      renderCalendar();
      renderDayPanel();
    </script>
  </body>
</html>
